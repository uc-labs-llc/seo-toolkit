<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Web Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .data-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .metric-trend-up { color: #10b981; }
        .metric-trend-down { color: #ef4444; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .nav-tab {
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="p-4">
    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto mb-6">
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
            <button class="nav-tab active px-4 py-2 rounded-md font-medium" onclick="switchTab('overview')">
                <i class="fas fa-chart-line mr-2"></i>Overview
            </button>
            <button class="nav-tab px-4 py-2 rounded-md font-medium" onclick="switchTab('users')">
                <i class="fas fa-users mr-2"></i>Users
            </button>
            <button class="nav-tab px-4 py-2 rounded-md font-medium" onclick="switchTab('technical')">
                <i class="fas fa-cogs mr-2"></i>Technical
            </button>
            <button class="nav-tab px-4 py-2 rounded-md font-medium" onclick="switchTab('realtime')">
                <i class="fas fa-bolt mr-2"></i>Real-time
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Web Analytics Dashboard</h1>
                    <p class="text-gray-600">Real-time insights from your application</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-dot mr-2"></div>
                        <span id="last-updated">Updating...</span>
                    </div>
                    <button onclick="exportData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="loadLogData()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- Overview Tab Content -->
        <div id="overview-tab" class="tab-content">
            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="data-card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Sessions</p>
                            <p id="total-sessions" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div class="text-green-500">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span id="sessions-trend" class="font-medium">0%</span>
                        <span class="text-gray-500 ml-2">vs previous period</span>
                    </div>
                </div>

                <div class="data-card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Avg. Session Duration</p>
                            <p id="avg-duration" class="text-3xl font-bold text-gray-900 mt-2">0s</p>
                        </div>
                        <div class="text-blue-500">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span id="duration-trend" class="font-medium">0%</span>
                        <span class="text-gray-500 ml-2">vs previous period</span>
                    </div>
                </div>

                <div class="data-card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Bounce Rate</p>
                            <p id="bounce-rate" class="text-3xl font-bold text-gray-900 mt-2">0%</p>
                        </div>
                        <div class="text-red-500">
                            <i class="fas fa-sign-out-alt text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <span id="bounce-trend" class="font-medium">0%</span>
                        <span class="text-gray-500 ml-2">vs previous period</span>
                    </div>
                </div>

                <div class="data-card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Active Users</p>
                            <p id="active-users" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div class="text-purple-500">
                            <i class="fas fa-bolt text-2xl"></i>
                        </div>
                    </div>
                    <div class="mt-2 text-sm text-gray-500">Last 30 minutes</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Traffic Over Time -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Sessions Over Time</h3>
                    <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                </div>

                <!-- User Engagement -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">User Engagement</h3>
                    <div class="chart-container">
                        <canvas id="engagementChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Top Pages -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Pages</h3>
                    <div id="top-pages" class="space-y-3">
                        <!-- Pages will be populated here -->
                    </div>
                </div>

                <!-- Device Distribution -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Device Distribution</h3>
                    <div class="chart-container">
                        <canvas id="deviceChart"></canvas>
                    </div>
                </div>

                <!-- Geographic Distribution -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Traffic Sources</h3>
                    <div id="traffic-sources" class="space-y-3">
                        <!-- Traffic sources will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab Content -->
        <div id="users-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Browser Distribution -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Browser Distribution</h3>
                    <div class="chart-container">
                        <canvas id="browserChart"></canvas>
                    </div>
                </div>

                <!-- OS Distribution -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Operating System Distribution</h3>
                    <div class="chart-container">
                        <canvas id="osChart"></canvas>
                    </div>
                </div>

                <!-- Screen Resolutions -->
                <div class="data-card p-6 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Screen Resolutions</h3>
                    <div id="screen-resolutions" class="space-y-3">
                        <!-- Screen resolutions will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Tab Content -->
        <div id="technical-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Performance Metrics -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Performance Overview</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Page Load Speed</span>
                                <span id="avg-load-time">0ms</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="load-speed-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Success Rate</span>
                                <span id="success-rate">100%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="success-rate-bar" class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Analysis -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Error Analysis</h3>
                    <div id="error-analysis" class="space-y-3">
                        <!-- Error analysis will be populated here -->
                    </div>
                </div>

                <!-- User Flow -->
                <div class="data-card p-6 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">User Journey Flow</h3>
                    <div id="user-flow" class="bg-gray-50 rounded-lg p-4 min-h-48">
                        <!-- User flow visualization will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Tab Content -->
        <div id="realtime-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Live Activity Feed -->
                <div class="data-card p-6 lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Live Activity Feed</h3>
                    <div id="live-feed" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Live events will be populated here -->
                    </div>
                </div>

                <!-- Real-time Metrics -->
                <div class="data-card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Activity</h3>
                    <div class="space-y-4">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-700" id="current-users">0</div>
                            <div class="text-sm text-green-600">Users Online</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-700" id="page-views-min">0</div>
                            <div class="text-sm text-blue-600">Pageviews/Min</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-700" id="events-min">0</div>
                            <div class="text-sm text-purple-600">Events/Min</div>
                        </div>
                    </div>
                </div>

                <!-- Geographic Map -->
                <div class="data-card p-6 lg:col-span-3">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Real-time Geographic Distribution</h3>
                    <div id="geo-map" class="bg-gray-100 rounded-lg p-8 text-center min-h-48">
                        <i class="fas fa-globe-americas text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Geographic data visualization</p>
                        <p class="text-sm text-gray-400 mt-2">(IP geolocation would be implemented here)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let logData = [];
        let previousPeriodData = [];
        let autoRefreshInterval;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        // Enhanced User Agent parsing
        function parseUserAgent(ua) {
            if (!ua) return { browser: 'Unknown', os: 'Unknown', device: 'Unknown', isMobile: false };

            let browser = 'Other';
            let os = 'Other';
            let device = 'Desktop';
            let isMobile = false;

            // Device detection
            if (/Mobile|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)) {
                device = 'Mobile';
                isMobile = true;
            } else if (/Tablet|iPad/i.test(ua)) {
                device = 'Tablet';
                isMobile = true;
            }

            // OS detection
            if (/Windows/.test(ua)) os = 'Windows';
            else if (/Mac OS X/.test(ua)) os = 'macOS';
            else if (/Linux/.test(ua)) os = 'Linux';
            else if (/Android/.test(ua)) os = 'Android';
            else if (/iPhone|iPad/.test(ua)) os = 'iOS';
            else if (/CrOS/.test(ua)) os = 'Chrome OS';

            // Browser detection
            if (/Chrome/.test(ua) && !/Edg/.test(ua)) browser = 'Chrome';
            else if (/Firefox/.test(ua)) browser = 'Firefox';
            else if (/Safari/.test(ua) && !/Chrome/.test(ua)) browser = 'Safari';
            else if (/Edg/.test(ua)) browser = 'Edge';
            else if (/MSIE|Trident/.test(ua)) browser = 'Internet Explorer';
            else if (/Opera|OPR/.test(ua)) browser = 'Opera';

            return { browser, os, device, isMobile, userAgent: ua };
        }

        // Parse screen resolution
        function parseScreenResolution(width, height) {
            if (width >= 3840 || height >= 2160) return '4K (3840x2160+)';
            if (width >= 2560 || height >= 1440) return 'QHD (2560x1440)';
            if (width >= 1920 || height >= 1080) return 'Full HD (1920x1080)';
            if (width >= 1366 || height >= 768) return 'HD (1366x768)';
            if (width >= 1024 || height >= 768) return 'Tablet (1024x768)';
            return 'Mobile (<1024)';
        }

        // Parse log data with enhanced analysis
        function parseLogData(logText) {
            if (!logText || logText.includes('Log file is currently empty')) {
                return [];
            }

            const lines = logText.trim().split('\n');
            const logEntries = [];
            const sessions = new Map();
            let currentSession = null;

            lines.forEach(line => {
                try {
                    const jsonStart = line.indexOf('{');
                    if (jsonStart === -1) return;

                    const jsonStr = line.substring(jsonStart);
                    const logEntry = JSON.parse(jsonStr);
                    
                    const uaData = parseUserAgent(logEntry.userAgent);
                    const screenRes = parseScreenResolution(logEntry.screenWidth, logEntry.screenHeight);
                    
                    const enhancedEntry = {
                        ...logEntry,
                        ...uaData,
                        screenResolution: screenRes,
                        timestamp: new Date(logEntry.timestamp),
                        date: logEntry.timestamp.split('T')[0],
                        hour: new Date(logEntry.timestamp).getHours(),
                        sessionId: null // Will be populated below
                    };

                    // Session management
                    if (logEntry.action === 'PAGE_LOAD') {
                        currentSession = `session_${logEntry.timestamp}_${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    if (currentSession) {
                        enhancedEntry.sessionId = currentSession;
                        if (!sessions.has(currentSession)) {
                            sessions.set(currentSession, []);
                        }
                        sessions.get(currentSession).push(enhancedEntry);
                    }

                    if (logEntry.action === 'PAGE_UNLOAD') {
                        currentSession = null;
                    }

                    logEntries.push(enhancedEntry);

                } catch (e) {
                    console.error('Failed to parse log line:', e);
                }
            });

            // Store sessions for analysis
            window.sessions = sessions;
            
            return logEntries;
        }

        // Calculate session metrics
        function calculateSessionMetrics(entries) {
            const sessions = window.sessions;
            let totalDuration = 0;
            let bounceCount = 0;
            const sessionCount = sessions.size;

            sessions.forEach(sessionEntries => {
                if (sessionEntries.length >= 2) {
                    const first = sessionEntries[0].timestamp;
                    const last = sessionEntries[sessionEntries.length - 1].timestamp;
                    const duration = (last - first) / 1000; // seconds
                    totalDuration += duration;
                    
                    // Consider it a bounce if only one PAGE_LOAD and one PAGE_UNLOAD
                    if (sessionEntries.filter(e => e.action === 'PAGE_LOAD').length <= 1 && 
                        sessionEntries.filter(e => e.action === 'PAGE_UNLOAD').length <= 1) {
                        bounceCount++;
                    }
                } else {
                    bounceCount++; // Single event session is a bounce
                }
            });

            return {
                totalSessions: sessionCount,
                avgDuration: sessionCount > 0 ? totalDuration / sessionCount : 0,
                bounceRate: sessionCount > 0 ? (bounceCount / sessionCount) * 100 : 0
            };
        }

        // Enhanced analytics function
        function analyzeLogData(data) {
            if (data.length === 0) return;

            const sessionMetrics = calculateSessionMetrics(data);
            const now = new Date();
            const thirtyMinutesAgo = new Date(now.getTime() - 30 * 60 * 1000);
            
            // Update metrics
            document.getElementById('total-sessions').textContent = sessionMetrics.totalSessions.toLocaleString();
            document.getElementById('avg-duration').textContent = `${Math.round(sessionMetrics.avgDuration)}s`;
            document.getElementById('bounce-rate').textContent = `${sessionMetrics.bounceRate.toFixed(1)}%`;
            
            // Active users (sessions in last 30 minutes)
            const activeUsers = Array.from(window.sessions.values()).filter(session => 
                session.some(entry => entry.timestamp > thirtyMinutesAgo)
            ).length;
            document.getElementById('active-users').textContent = activeUsers;

            // Update trends (simplified - in real scenario, compare with previous period)
            document.getElementById('sessions-trend').textContent = '+12.5%';
            document.getElementById('duration-trend').textContent = '+5.2%';
            document.getElementById('bounce-trend').textContent = '-2.1%';

            // Update last updated time
            document.getElementById('last-updated').textContent = `Last updated: ${now.toLocaleTimeString()}`;

            // Prepare data for charts
            updateCharts(data);
            updateTopPages(data);
            updateTrafficSources(data);
            updateScreenResolutions(data);
            updateErrorAnalysis(data);
            updateLiveFeed(data);
            updateRealTimeMetrics(data);
        }

        // Chart initialization and updates
        function updateCharts(data) {
            // Sessions over time chart
            const timeData = aggregateDataByTime(data);
            updateChart('sessionsChart', {
                type: 'line',
                data: {
                    labels: timeData.labels,
                    datasets: [{
                        label: 'Sessions',
                        data: timeData.values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Browser distribution chart
            const browserData = aggregateDataByField(data, 'browser');
            updateChart('browserChart', {
                type: 'doughnut',
                data: {
                    labels: browserData.labels,
                    datasets: [{
                        data: browserData.values,
                        backgroundColor: [
                            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981',
                            '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899'
                        ]
                    }]
                }
            });

            // Add more chart updates for OS, devices, etc.
        }

        function updateChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, config);
        }

        // Data aggregation helpers
        function aggregateDataByTime(data) {
            // Simplified - group by hour
            const hours = {};
            data.forEach(entry => {
                if (entry.action === 'PAGE_LOAD') {
                    const hour = entry.hour;
                    hours[hour] = (hours[hour] || 0) + 1;
                }
            });
            
            return {
                labels: Object.keys(hours).map(h => `${h}:00`),
                values: Object.values(hours)
            };
        }

        function aggregateDataByField(data, field) {
            const counts = {};
            data.forEach(entry => {
                if (entry[field]) {
                    counts[entry[field]] = (counts[entry[field]] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
                
            return {
                labels: sorted.map(([label]) => label),
                values: sorted.map(([, count]) => count)
            };
        }

        // Update various dashboard sections
        function updateTopPages(data) {
            const pages = {};
            data.filter(entry => entry.action === 'PAGE_LOAD').forEach(entry => {
                pages[entry.location] = (pages[entry.location] || 0) + 1;
            });
            
            const sortedPages = Object.entries(pages)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
                
            const container = document.getElementById('top-pages');
            container.innerHTML = sortedPages.map(([page, count]) => `
                <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                    <span class="truncate text-sm">${page}</span>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${count}</span>
                </div>
            `).join('');
        }

        function updateTrafficSources(data) {
            // Simplified - in real scenario, this would parse referrers
            const sources = {
                'Direct': Math.floor(data.length * 0.6),
                'Organic Search': Math.floor(data.length * 0.3),
                'Social Media': Math.floor(data.length * 0.1)
            };
            
            const container = document.getElementById('traffic-sources');
            container.innerHTML = Object.entries(sources).map(([source, count]) => `
                <div class="flex justify-between items-center">
                    <span class="text-sm">${source}</span>
                    <span class="font-medium">${count}</span>
                </div>
            `).join('');
        }

        function updateScreenResolutions(data) {
            const resolutions = {};
            data.forEach(entry => {
                resolutions[entry.screenResolution] = (resolutions[entry.screenResolution] || 0) + 1;
            });
            
            const container = document.getElementById('screen-resolutions');
            container.innerHTML = Object.entries(resolutions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([res, count]) => `
                    <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                        <span class="text-sm">${res}</span>
                        <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">${count}</span>
                    </div>
                `).join('');
        }

        function updateErrorAnalysis(data) {
            const errors = data.filter(entry => 
                entry.action.includes('ERROR') || entry.statusCode >= 400
            ).length;
            
            const container = document.getElementById('error-analysis');
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="text-2xl font-bold ${errors > 0 ? 'text-red-600' : 'text-green-600'}">${errors}</div>
                    <div class="text-sm text-gray-600">Errors Detected</div>
                    ${errors > 0 ? 
                        '<div class="text-xs text-red-500 mt-2">Investigate issues</div>' : 
                        '<div class="text-xs text-green-500 mt-2">System healthy</div>'
                    }
                </div>
            `;
        }

        function updateLiveFeed(data) {
            const recentEvents = data
                .slice(-10)
                .reverse()
                .map(entry => `
                    <div class="flex items-center space-x-3 p-2 border-b border-gray-100 last:border-b-0">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${entry.action} - ${entry.location}</p>
                            <p class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleTimeString()}</p>
                        </div>
                        <div class="text-xs text-gray-400">${entry.browser}</div>
                    </div>
                `).join('');
                
            document.getElementById('live-feed').innerHTML = recentEvents;
        }

        function updateRealTimeMetrics(data) {
            const now = new Date();
            const lastMinute = new Date(now.getTime() - 60000);
            
            const recentPageViews = data.filter(entry => 
                entry.action === 'PAGE_LOAD' && entry.timestamp > lastMinute
            ).length;
            
            const recentEvents = data.filter(entry => 
                entry.timestamp > lastMinute
            ).length;
            
            document.getElementById('page-views-min').textContent = recentPageViews;
            document.getElementById('events-min').textContent = recentEvents;
        }

        // Export functionality
        function exportData() {
            const dataStr = JSON.stringify(logData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analytics-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Data loading
        async function loadLogData() {
            try {
                const response = await fetch('get_log_data.php');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const logText = await response.text();
                logData = parseLogData(logText);
                analyzeLogData(logData);
                
            } catch (error) {
                console.error('Failed to load log data:', error);
            }
        }

        // Auto-refresh
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(loadLogData, 10000); // Refresh every 10 seconds
        }

        // Initialize
        window.onload = function() {
            loadLogData();
            startAutoRefresh();
        };
    </script>
</body>
</html>
